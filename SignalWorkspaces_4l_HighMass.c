//Fit parameters of ggH resolution
//ggH_2mu2e
double dcbPara_2e2mu_ggh[6][5] = {
  6.98993278E-01, 2.27012659E-02, 1.18791281E-03, -5.10161601E-05, 8.08788473E-09,
  1.02944886E+00, 9.30020343E-02, -4.01627331E-03, 4.33012494E-05, -2.15223207E-10,
  -6.90015904E-01, 3.10207613E-02, -6.79939348E-03, 1.40115882E-04, -1.22471359E-08,
  -2.79419963E+00, 6.46750642E-01, -2.79889274E-02, 4.38429652E-04, -3.88766543E-08,
  2.92787192E+00, -3.21961102E-01, 3.64912692E-02, -7.70312565E-04, 7.02219631E-08,
  1.36241839E+01, -2.23685503E+00, 1.36765710E-01, -2.36482863E-03, 2.03270314E-07
};

//ggH_4e
double dcbPara_4e_ggh[6][5] = {
  4.57957636E-02, 1.28006042E-01, -4.83968162E-03, 6.93731453E-05, -4.84767035E-09,
  2.95435954E+00, -1.32885128E-01, 3.93901942E-03, -4.43698062E-05, 2.27062137E-09,
  2.28337193E+00, -5.50596277E-01, 2.16855252E-02, -3.33241124E-04, 2.81449450E-08,
  -2.11157415E+00, 4.33976549E-01, -2.72203075E-03, -1.75795880E-06, -1.72484991E-09,
  3.17842156E+00, -6.85886987E-02, 1.44076683E-03, -2.12408835E-05, 1.49639013E-09,
  -2.12019025E+01, 2.94423175E+00, -1.02343403E-01, 1.22361246E-03, -5.95041888E-08
};

//ggH_4mu
double dcbPara_4mu_ggh[6][5] = {
 -1.68172934E-01, 2.02277863E-01, -9.35819841E-03, 1.48041218E-04, -1.20862139E-08,
 2.56497232E-01, 2.78912600E-01, -1.58807791E-02,  2.77070406E-04, -2.42954508E-08,
 2.92205689E+00, -3.37135417E-01, 1.01407516E-02, -1.44454380E-04, 1.56252853E-08,
 7.92166527E+00, -1.06771470E+00, 5.92733055E-02, -1.02921360E-03, 8.82356055E-08,
 1.44697370E+01, -2.55493097E+00, 1.63176121E-01, -3.08701868E-03, 2.94692969E-07,
 9.39310132E+00, -1.88025423E+00, 1.24541545E-01, -2.12473274E-03, 1.78621921E-07
};

//Fit parameters of VBF resolution
//VBFH_2mu2e
double dcbPara_2e2mu_vbfh[6][5] = {
  5.15912424E-02, 1.28338115E-01, -4.98253676E-03, 7.00301536E-05, -5.05958876E-09,
  1.84436018E+00, 1.62558048E-02, -2.67460602E-03, 5.52760648E-05, -4.89450448E-09,
  -1.63815056E+00, 2.31887757E-01, -1.84240809E-02, 3.36956002E-04, -3.25052426E-08,
  -2.52261959E+00, 6.26556805E-01, -2.88882202E-02, 5.04933455E-04, -5.23362768E-08,
  -1.78136627E+01, 1.87374799E+00, -3.78914817E-02, 7.79764997E-05, 4.40714574E-08,
  2.51153342E+00, -2.91834808E-01, 2.14713028E-02, -9.24157857E-06, -9.89945399E-10
};

//VBFH_4e
double dcbPara_4e_vbfh[6][5] = {
  1.04442832E+00, -3.30321962E-03, 8.74572728E-04, -2.39666785E-05, 4.13203301E-09,
  4.44106180E+00, -2.77215590E-01, 8.30685452E-03, -8.35934514E-05, 2.16792656E-09,
  3.01825339E-01, -2.50201526E-01, 6.16508506E-03, -5.27559598E-05, -4.47800396E-09,
  8.61201502E-01, 2.28483454E-01, -1.14251979E-02, 2.03119803E-04, -2.23535731E-08,
  -1.12669148E+01, 1.19857741E+00, -1.94488776E-02, -7.48710870E-05, 4.32591770E-08,
  3.25760175E+00, -2.16039777E-01, 1.96479896E-02, -1.91523118E-04, 6.70552797E-09
};

//VBFH_4mu
double dcbPara_4mu_vbfh[6][5] = {
  1.46662022E-01, 1.52715581E-01, -6.67635807E-03, 9.40680455E-05, -4.99665322E-09,
  7.96841222E+00, -7.81354035E-01, 3.21908120E-02, -4.86797708E-04, 4.01593221E-08,
  3.13716732E+00, -3.31164653E-01, 7.66140685E-03, -6.23108287E-05, -4.91781482E-09,
  -3.84067000E+00, 5.77653995E-01, -1.65582144E-02, 1.55644492E-04, -2.43169985E-09,
  -3.19267559E+01, 3.95868469E+00, -1.40295060E-01, 1.73398081E-03, -9.11119810E-08,
  1.78990152E+00, -5.83679195E-01, 4.68998231E-02, -4.64278226E-04, 5.36840145E-08
};

//Fit parameters of ggH efficiency
double eff[3][11]={
	// ggH 4e
	3.50790357E-01,  1.02270597E-09,  1.08931058E+02, -6.52126661E+01, -2.45620131E+08, -5.12226737E+04,  4.72238970E+01, -8.48236460E+01,  7.95274134E+11, -6.06225022E+12, -8.86606924E-03,
	// ggH 4mu
	3.26988994E-01,  2.02100500E-09,  7.19757598E+01, -7.07327414E+01, -2.63223346E+08, -4.28141677E+04,  2.77936336E+01, -6.26473129E+02,  1.63823664E+12, -4.96516470E+12, -4.87568669E-03,
	// ggH 2e2mu
	-1.97695202E-01, -2.10927700E-05,  4.50196470E+01, -8.66616718E+01,  4.64995700E+04,  3.12945990E+00, -2.45157244E-03,  5.87407073E+09, -3.91399393E+09, -8.26586070E+09,  4.52072370E-07
};
//Fit parameters of VBF efficiency
double eff_vbf[3][11]={
	// VBF  4e
        8.23040680E-02, -3.25490416E-05,  9.63504985E+01, -6.92243674E+01,  9.24987742E+03,  9.91162663E+00, -5.38159448E-03,  2.59306471E+00,  4.45648262E+02,  5.56733569E+08,  8.24827867E-07,
	// VBF  4mu
        2.40015717E-01, -2.48155773E-10,  9.63008329E+01,  5.39626511E+01, -1.04818401E+09, -2.30388228E+06,  1.22391301E+03, -1.40988985E+08, -5.30160942E+07,  2.23470245E+08, -2.00394487E-01,
	// VBF  2e2mu
	9.56521298E-02,  4.52429308E-06,  9.54308591E+01, -5.82690034E+01, -7.30743805E+04, -1.02734900E+02,  5.54005132E-02,  4.50505734E+08, -6.82451995E+08,  1.28653688E+13, -8.82100590E-06

};

//Lists for the xsec as a function of the mass, it will be use for the  (should be done inside a file)
double mass_H[155]={10.00,15.00,20.00,25.00,30.00,35.00,40.00,45.00,50.00,55.00,60.00,65.00,70.00,75.00,80.00,85.00,90.00,95.00,100.00,105.00,110.00,115.00,120.00,125.00,130.00,135.00,140.00,145.00,150.00,160.00,170.00,180.00,190.00,200.00,210.00,220.00,230.00,240.00,250.00,260.00,270.00,280.00,290.00,300.00,310.00,320.00,330.00,340.00,350.00,360.00,370.00,380.00,390.00,400.00,410.00,420.00,430.00,440.00,450.00,460.00,470.00,480.00,490.00,500.00,550.00,600.00,650.00,700.00,750.00,800.00,850.00,900.00,950.00,1000.00,1050.00,1100.00,1150.00,1200.00,1250.00,1300.00,1350.00,1400.00,1450.00,1500.00,1550.00,1600.00,1650.00,1700.00,1750.00,1800.00,1850.00,1900.00,1950.00,2000.00,2050.00,2100.00,2150.00,2200.00,2250.00,2300.00,2350.00,2400.00,2450.00,2500.00,2550.00,2600.00,2650.00,2700.00,2750.00,2800.00,2850.00,2900.00,2950.00,3000.00,3050.00,3100.00,3150.00,3200.00,3250.00,3300.00,3350.00,3400.00,3450.00,3500.00,3550.00,3600.00,3650.00,3700.00,3750.00,3800.00,3850.00,3900.00,3950.00,4000.00,4050.00,4100.00,4150.00,4200.00,4250.00,4300.00,4350.00,4400.00,4450.00,4500.00,4550.00,4600.00,4650.00,4700.00,4750.00,4800.00,4850.00,4900.00,4950.00,5000.00};

double xsec_mass_H[155]={1.900E+03,1.203E+03,8.458E+02,6.322E+02,4.923E+02,3.949E+02,3.240E+02,2.706E+02,2.294E+02,1.968E+02,1.706E+02,1.492E+02,1.315E+02,1.166E+02,1.041E+02,9.340E+01,8.420E+01,7.630E+01,6.930E+01,6.320E+01,5.790E+01,5.310E+01,4.890E+01,4.520E+01,4.180E+01,3.880E+01,3.600E+01,3.350E+01,3.129E+01,2.737E+01,2.409E+01,2.132E+01,1.896E+01,1.694E+01,1.520E+01,1.369E+01,1.237E+01,1.122E+01,1.020E+01,9.300E+00,8.510E+00,7.800E+00,7.160E+00,6.590E+00,6.080E+00,5.620E+00,5.200E+00,4.820E+00,4.480E+00,4.160E+00,3.880E+00,3.620E+00,3.380E+00,3.160E+00,2.960E+00,2.770E+00,2.600E+00,2.440E+00,2.300E+00,2.160E+00,2.030E+00,1.920E+00,1.810E+00,1.709E+00,1.297E+00,1.001E+00,7.834E-01,6.206E-01,4.969E-01,4.015E-01,3.271E-01,2.685E-01,2.219E-01,1.845E-01,1.542E-01,1.295E-01,1.093E-01,9.260E-02,7.880E-02,6.730E-02,5.760E-02,4.950E-02,4.270E-02,3.690E-02,3.190E-02,2.770E-02,2.410E-02,2.100E-02,1.838E-02,1.609E-02,1.411E-02,1.239E-02,1.090E-02,9.600E-03,8.470E-03,7.480E-03,6.620E-03,5.860E-03,5.190E-03,4.610E-03,4.090E-03,3.640E-03,3.240E-03,2.890E-03,2.570E-03,2.300E-03,2.050E-03,1.830E-03,1.640E-03,1.460E-03,1.310E-03,1.170E-03,1.050E-03,9.400E-04,8.470E-04,7.600E-04,6.820E-04,6.130E-04,5.510E-04,4.950E-04,4.450E-04,4.000E-04,3.600E-04,3.240E-04,2.920E-04,2.630E-04,2.370E-04,2.130E-04,1.920E-04,1.730E-04,1.560E-04,1.410E-04,1.270E-04,1.140E-04,1.030E-04,9.300E-05,8.400E-05,7.600E-05,6.800E-05,6.100E-05,5.500E-05,5.000E-05,4.500E-05,4.100E-05,3.700E-05,3.300E-05,3.000E-05,2.700E-05,2.400E-05,2.200E-05,2.000E-05,1.800E-05,1.600E-05,1.400E-05};

using namespace RooFit;

//To select the production mode
TString sampleName[2]={"ggH","VBF"};
TString dataName[2]={"ggH","qqH"};
TString workName[2]={"1D","2D"};

//Bkg files (ggZZ->2l2l' and ggZZ->4l)
TString bkgName[2][2]={
	"/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ggTo2e2mu_Contin_MCFM701_redTree_2018.root","/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ggTo4mu_Contin_MCFM701_redTree_2018.root",
	"/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ZZTo4lext_redTree_2018.root","/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ZZTo4lext_redTree_2018.root"
};//qqZZ should be changed for qqZZ EWK

//H125 files for interferences (should be changed for offshell samples)
TString hName[2][2]={
	"/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ggH125_redTree_2018_int.root","/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/ggH125_redTree_2018_int.root",
	"/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/VBFH125_redTree_2018_int.root","/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/ReducedTrees/VBFH125_redTree_2018_int.root",
};

float bkgxsec[2][2]={3.19,1.59,0.642,0.310}; // ggH/VBF 2e2mu/4e
float hxsec[2][2]={0.855*3.425*1.15,0.452*3.425*1.15,0.248*1.4568*1.15,0.133*1.4568*1.15};// Remember to revert it back

//Function doing everything: create the analytical shape and convoluate it with the resolution and efficiency, then add bkg and interference contributions
//Take as input the channel name (4e, 4mu, 2e2mu), the resonance mass and width, the production mode(0=ggH,1=VBF), the category, and the number of dimension (0=1D, 1=2D)
void workspaceProducer(TString chan="2e2mu",double mass_d=450, double width_d=46.8,int sample =0, int cate_vbf=0,int is2D=1){
	int chanN = 0;
	if(chan!="2e2mu")
		chanN=1;

	double sigfull, bkgfull,hfull,lumi,signum;
	
	//lumi = 35.92; //lumi 2016
	//lumi = 41.53; //lumi 2017
	lumi = 59.74; //lumi 2018
	
	//	sigfull = 0.0673*0.0673*lumi*1000*0.6138650761079254; //Remember to revert it back
	sigfull = 0.0673*0.0673*lumi; //Remember to revert it back

	TChain *t125 = new TChain ("SelectedTree");
	TChain *ggzz = new TChain("SelectedTree");

	t125->Add(hName[sample][chanN]);
	ggzz->Add(bkgName[sample][chanN]);
	hfull = hxsec[sample][chanN]*lumi;
	bkgfull = bkgxsec[sample][chanN]*lumi;

	//Select the resolution and efficiency parameters depending on the production mode and final state
	double dcbPara_2nd[6][5];
	double effsig[11]={0.};

	if (chan=="4e") 	{
		if(sample){
			for (int i=0;i<11;i++){effsig[i]=eff_vbf[0][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_4e_vbfh[i][j];}}
		}
		else{
			for (int i=0;i<11;i++){effsig[i]=eff[0][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_4e_ggh[i][j];}}
		}
	} 
	if (chan=="4mu")  {
	        if(sample){
			for (int i=0;i<11;i++){effsig[i]=eff_vbf[1][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_4mu_vbfh[i][j];}}
		}
		else{
		        for (int i=0;i<11;i++){effsig[i]=eff[1][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_4mu_ggh[i][j];}}
		}
	}
	if (chan=="2e2mu") {
	        if(sample){
			for (int i=0;i<11;i++){effsig[i]=eff_vbf[2][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_2e2mu_vbfh[i][j];}}
		}
		else{
			for (int i=0;i<11;i++){effsig[i]=eff[2][i];}
		        for (int i=0;i<6;i++){for(int j=0;j<5;j++){dcbPara_2nd[i][j]= dcbPara_2e2mu_ggh[i][j];}}
		}
	}
	
	RooWorkspace w("w");

	//Define range of gen and reco mass
	const double low=100;
	const double high=3500;
	const int nbins=int(high-low);

	//Different lower range limits were used for the different categories
	double lowvalue [3]={200.,200.,200.};

	const double low_reco=lowvalue[cate_vbf];
	const double high_reco=3500;
	const int nbins_reco=int(high_reco-low_reco);


	//Define gen mass and reco mass
	RooRealVar* mzz = new RooRealVar("ZZMass_gen","M_{ZZ} (GeV)",450,low,high); //GenHMass
	RooRealVar* dbkg= new RooRealVar("dbkg_kin","Dbkg_{kin} ",0.5,0.,1.);
	RooRealVar* mreco= new RooRealVar("mreco","M_{ZZ} (GeV)",450,low_reco,high_reco); //ZZMass

	RooPlot* frame= mreco->frame(Title("Z mass")) ;
	RooPlot* frame2= mreco->frame(Title("Z mass")) ;
	RooPlot* frame_dbkg= dbkg->frame(Title("")) ;
	RooRealVar* mean = new RooRealVar("mean","mean",450,100,3000);
	RooRealVar* sigma= new RooRealVar("sigma","sigma",50,0.,2000);
	RooRealVar *r= new RooRealVar("r","",1,0,1000);
	RooRealVar *vbfrac= new RooRealVar("fvbf","",0,0,1.);
	RooFormulaVar* signorm;
	
	//Normalization ggH vs VBF
	if(sample==0){
		signorm =new RooFormulaVar("signorm_"+sampleName[sample],"@0*(1-@1)",RooArgSet(*r,*vbfrac));
        }
	else{
		vbfrac->setVal(1);
		signorm =new RooFormulaVar("signorm_"+sampleName[sample],"@0*@1",RooArgSet(*r,*vbfrac));
	}

	//Part for computing the analytical shape
	TSpline3 *lo= new TSpline3("lo",mass_H, xsec_mass_H, 155);//Should be changed for 2l2l'
	TSpline3 *lo_4e= new TSpline3("lo_4e",mass_H, xsec_mass_H, 155);
	
  	double pole2e2mu ,pole4e;//Two cases are considered 4l and 2l2l'
	pole2e2mu = lo->Eval(mass_d);
	pole4e= lo_4e->Eval(mass_d);

	SplinePdf *pdf;
	SplinePdf *pdf_other;

	if(chan=="2e2mu"){
		pdf=new SplinePdf("pdf_"+chan,"",*mzz,*mean,*sigma,*lo);
		pdf_other=new SplinePdf("pdf_other","",*mzz,*mean,*sigma,*lo_4e);
		if(width_d<0.5)
			signum = sigfull*pole2e2mu/(pole2e2mu+pole4e*2);
		else{
			double integralsum = (pdf->createIntegral(*mzz))->getVal();
			double integralsum_other= (pdf_other->createIntegral(*mzz))->getVal();
			signum = integralsum/(integralsum+integralsum_other*2.)*sigfull;
			cout<<integralsum/(integralsum+integralsum_other*2.)<<endl;
		}
	}
	else{
		pdf=new SplinePdf("pdf_"+chan,"",*mzz,*mean,*sigma,*lo_4e);
		pdf_other=new SplinePdf("pdf_other","",*mzz,*mean,*sigma,*lo);
		if(width_d<0.5)
			signum = sigfull*pole4e/(pole2e2mu+pole4e*2);
		else{
			double integralsum = (pdf->createIntegral(*mzz))->getVal();
			double integralsum_other= (pdf_other->createIntegral(*mzz))->getVal();
			signum = integralsum/(integralsum*2+integralsum_other)*sigfull;
			cout<<integralsum/(integralsum*2+integralsum_other)<<endl;
		}
	}

	//Part for H125
	TFile *fkfactor = new TFile("/eos/user/a/axbuchot/SWAN_projects/HighMass/Kfactor_Collected_ggHZZ_2l2l_NNLO_NNPDF_NarrowWidth_13TeV.root");
	TGraph *ggZZ_kf = (TGraph*)fkfactor->Get("kfactor_Nominal");

	RooPlot* frame_mzz= mzz->frame(Title("Z mass")) ;
	mean->setVal(125.);
	sigma->setVal(0.00407);

	double hall = t125->GetEntries("ZZMass!=0"); //Total number of events
	double hsel = t125->GetEntries(Form("ZZMass>%f&&ZZMass<%f",low,high)); //Number of events in the mass range
	double hnum = hsel/hall*hfull;

	TH1F *pdf125_hist=new TH1F("pdf125_hist","",nbins,low,high);       
	double bwid = (high-low)/double(nbins);
	for(int k=0;k<nbins;k++){
		double x = low+k*bwid;
		mzz->setVal(x);
		double bc_125= pdf->getVal(*mzz)*hnum*bwid; //Remember to revert it back
		if(x==125){
			bc_125=0;
			for(int j =-50;j<50;j++){
				mzz->setVal(x+j*0.2*0.00407);
				bc_125+=pdf->getVal(*mzz)*hnum*0.2*0.00407; //Remember to revert it back
			}
		}
		pdf125_hist->SetBinContent(k+1,bc_125);
	}

	//Signal
	mean->setVal(mass_d);
	sigma->setVal(width_d);

	//bkg
	double bkgall = ggzz->GetEntries("");
	double bkgsel = ggzz->GetEntries(Form("ZZMass>%f&&ZZMass<%f",low,high));
	double bkgnum = bkgsel/bkgall*bkgfull; 


	TH1F *genm= new TH1F ("genm","",nbins,low,high);
	ggzz->Draw("ZZMass>>genm",Form("ZZMass>%f",low));
	
	genm->Scale(bkgnum/genm->Integral());

	//Resolution
	//TString formu_2nd=" (@0<@1)*(@3+@0*@4+@0*@0*@5 ) + ( @0>=@1 && @0<@2)*(@6+@0*@7+@0*@0*@8) + (@0>=@2)*(@9+@0*@10+@0*@0*@11)"; //Meng's parametrization defined in three regions
	//Function used to fit resoltion parameters (could be changed for some parameters)
	TString formu_2nd="@1 + @2*TMath::Sqrt(@0) + @3*@0 + @4*@0*TMath::Sqrt(@0) + @5*@0*@0*TMath::Sqrt(@0)";

	RooArgList formuList_a1;
	RooArgList formuList_a2;
	RooArgList formuList_mean;
	RooArgList formuList_n1;
	RooArgList formuList_n2;
	RooArgList formuList_sigma;
	formuList_a1.add(*mzz);
	formuList_a2.add(*mzz);
	formuList_mean.add(*mzz);
	formuList_n1.add(*mzz);
	formuList_n2.add(*mzz);
	formuList_sigma.add(*mzz);

	RooConstVar* a1_p0_0_2nd[5] ;
	RooConstVar* a2_p0_0_2nd[5] ;
	RooConstVar* mean_p0_0_2nd[5] ;
	RooConstVar* n1_p0_0_2nd[5] ;
	RooConstVar* n2_p0_0_2nd[5] ;
	RooConstVar* sigma_p0_0_2nd[5] ;
	for(int i =0; i<5;i++){
		a1_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_a1_p0_0_2nd",chan.Data(),i),Form("%s_%d_a1_p0_0_2nd",chan.Data(),i),dcbPara_2nd[0][i]);
		a2_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_a2_p0_0_2nd",chan.Data(),i),Form("%s_%d_a2_p0_0_2nd",chan.Data(),i),dcbPara_2nd[1][i]);
		mean_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_mean_p0_0_2nd",chan.Data(),i),Form("%s_%d_mean_p0_0_2nd",chan.Data(),i),dcbPara_2nd[2][i]);
		n1_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_n1_p0_0_2nd",chan.Data(),i),Form("%s_%d_n1_p0_0_2nd",chan.Data(),i),dcbPara_2nd[3][i]);
		n2_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_n2_p0_0_2nd",chan.Data(),i),Form("%s_%d_n2_p0_0_2nd",chan.Data(),i),dcbPara_2nd[4][i]);
		sigma_p0_0_2nd[i]= new RooConstVar(Form("%s_%d_sigma_p0_0_2nd",chan.Data(),i),Form("%s_%d_sigma_p0_0_2nd",chan.Data(),i),dcbPara_2nd[5][i]);
		
		formuList_a1.add(*a1_p0_0_2nd[i]);
		formuList_a2.add(*a2_p0_0_2nd[i]);
		formuList_mean.add(*mean_p0_0_2nd[i]);
		formuList_n1.add(*n1_p0_0_2nd[i]);
		formuList_n2.add(*n2_p0_0_2nd[i]);
		formuList_sigma.add(*sigma_p0_0_2nd[i]);
	}

	RooFormulaVar* a1_p0_2nd= new RooFormulaVar("a1_p0_2nd"+chan,"a1_p0_2nd"+chan,formu_2nd,formuList_a1);
	RooFormulaVar* a2_p0_2nd= new RooFormulaVar("a2_p0_2nd"+chan,"a2_p0_2nd"+chan,formu_2nd,formuList_a2);
	RooFormulaVar* mean_p0_2nd= new RooFormulaVar("mean_p0_2nd"+chan,"mean_p0_2nd"+chan,formu_2nd,formuList_mean);
	RooFormulaVar* n1_p0_2nd= new RooFormulaVar("n1_p0_2nd"+chan,"n1_p0_2nd"+chan,formu_2nd,formuList_n1);
	RooFormulaVar* n2_p0_2nd= new RooFormulaVar("n2_p0_2nd"+chan,"n2_p0_2nd"+chan,formu_2nd,formuList_n2);
	RooFormulaVar* sigma_p0_2nd= new RooFormulaVar("sigma_p0_2nd"+chan,"sigma_p0_2nd"+chan,formu_2nd,formuList_sigma);

	RooFormulaVar *sigma_p0_up = new RooFormulaVar("sigma_p0_up"+chan,"","@0+0.2*@0",*sigma_p0_2nd);
	RooFormulaVar *sigma_p0_dn = new RooFormulaVar("sigma_p0_dn"+chan,"","@0-0.2*@0",*sigma_p0_2nd);

	RooDoubleCB dcrReso_piece("dcrReso"+chan,"Double Crystal ball ",*mreco,*mzz,*mean_p0_2nd,*sigma_p0_2nd,*a1_p0_2nd,*n1_p0_2nd,*a2_p0_2nd,*n2_p0_2nd);
	RooDoubleCB dcrReso_piece_up("dcrReso"+chan+"_up","dcb up",*mreco,*mzz,*mean_p0_2nd,*sigma_p0_up,*a1_p0_2nd,*n1_p0_2nd,*a2_p0_2nd,*n2_p0_2nd);
	RooDoubleCB dcrReso_piece_dn("dcrReso"+chan+"_dn","dcb dn",*mreco,*mzz,*mean_p0_2nd,*sigma_p0_dn,*a1_p0_2nd,*n1_p0_2nd,*a2_p0_2nd,*n2_p0_2nd);
	
	//Import the templates
	TFile *ftemplate=new TFile("/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/template/templates_int_HM_"+chan+"2018.root");

	TH2F *template_1= (TH2F*)ftemplate->Get("template2d_ggh");
	TH2F *template_2= (TH2F*)ftemplate->Get("template2d_ggzz");
	TH2F *template_124= (TH2F*)ftemplate->Get("template2d_ggh125"); //Should be changed
	TH2F *template_124Im= (TH2F*)ftemplate->Get("template2d_ggh125"); //Should be changed
	
	if(sample){
	    TH2F *template_1= (TH2F*)ftemplate->Get("template2d_vbf");
	    TH2F *template_2= (TH2F*)ftemplate->Get("template2d_qqzz"); //Should be changed for EW qqZZ
	    TH2F *template_124= (TH2F*)ftemplate->Get("template2d_vbf125"); //Should be changed
	    TH2F *template_124Im= (TH2F*)ftemplate->Get("template2d_vbf125"); //Should be changed
	}
	else{
	    TH2F *template_1= (TH2F*)ftemplate->Get("template2d_ggh");
	    TH2F *template_2= (TH2F*)ftemplate->Get("template2d_ggzz");
	    TH2F *template_124= (TH2F*)ftemplate->Get("template2d_ggh125"); //Should be changed
	    TH2F *template_124Im= (TH2F*)ftemplate->Get("template2d_ggh125"); //Should be changed
	}
	TH2F *template_1r= new TH2F("template1","",nbins,low,high,30,0.,1.); 
	TH2F *template_2r= new TH2F("template2","",nbins,low,high,30,0.,1.); 
	TH2F *template_124r= new TH2F("template124","",nbins,low,high,30,0.,1.); 

	TH2F *conv_template_1= new TH2F("conv_template1","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_2= new TH2F("conv_template2","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_124= new TH2F("conv_template124","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 

	TH2F *conv_template_1_up= new TH2F("conv_template1_up","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_2_up= new TH2F("conv_template2_up","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_124_up= new TH2F("conv_template124_up","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 

	TH2F *conv_template_1_dn= new TH2F("conv_template1_dn","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_2_dn= new TH2F("conv_template2_dn","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 
	TH2F *conv_template_124_dn= new TH2F("conv_template124_dn","",nbins_reco/2,low_reco,high_reco,30,0.,1.); 

	TString phaseName[2]={"/eos/user/a/axbuchot/SWAN_projects/HighMass/fphase_ggH.root","/eos/user/a/axbuchot/SWAN_projects/HighMass/fgraph_vbf_phase.root"}; //interference phase distribution (given by Meng)
	TString cName[2]={"cosspline","cos"};
	TString sName[2]={"sinspline","sin"};
	TString gName[2]={"ggZZ","VBF"};

	TFile *fphase_noweight=new TFile(phaseName[sample]);
	TGraph *cosfunc = (TGraph*)fphase_noweight->Get(cName[sample]);
	TGraph *sinfunc = (TGraph*)fphase_noweight->Get(sName[sample]);

	TFile *bkgeff = new TFile ("/eos/user/a/axbuchot/SWAN_projects/HighMass/bkg_reg_eff.root"); //bkg efficiency
	TGraph *effwhat=  (TGraph*)bkgeff->Get(gName[sample]+"_reg_"+chan);

	TAxis *xax = template_1->GetXaxis();
	double inter_all;

	for (int i =0; i< nbins;i++){

		double x = low+ (high-low)/double(nbins)*i;

		mzz->setVal(x);
		
		double bc =signum*(fabs((mass_d-x))<0.1);
		if(width_d>0.5)
			bc = pdf->getVal(*mzz)*signum*bwid;
		double bc_bkg= genm->GetBinContent(i+1);
		double bc_125= pdf125_hist->GetBinContent(i+1);

		double effval = (effsig[0]+effsig[1]*TMath::Erf( (x-effsig[2])/effsig[3] ))*(effsig[4]+effsig[5]*x+effsig[6]*x*x+effsig[10]*x*x*x)+effsig[7]*TMath::Gaus(x,effsig[8],effsig[9]);
		double effval_bkg = effwhat->Eval(x);
		double m4l = x;
		double effcate_sig, effcate_sig_ori, effcate_bkg;
				
		if(!sample){
			effcate_sig= 0.0394; //Remember to revert it
			effcate_bkg=  (m4l<93 ? 0.086851-11.5824/(93+63.8731) : 0.086851-11.5824/(m4l+63.8731)); 
		}
		else{
			effcate_sig = 0.489193 - 5.21995e-05*m4l;
			effcate_bkg = (m4l < 200 ? (0.392357 + 0.002486*(m4l-200)) : (m4l < 300 ? 0.392357+0.000229678*(m4l-200) + -1.18962e-06*(m4l-200)*(m4l-200) : 171.93/(m4l+437.284) - 171.93/(300+437.284) + 0.392357+0.000229678*100 + -1.18962e-06*100*100 ));
		}
		effcate_sig_ori= effcate_sig;

		//Forced to 1 at the begining since the analysis use an inclusive category
		effcate_sig=1;
		effcate_sig_ori=1;
		effcate_bkg=1;
		effcate_sig_ori=1;

		double kfac = ggZZ_kf->Eval(x);
		if(sample)
			kfac=1;

		double fa_sig = bc*abs(effval)*effcate_sig_ori; // effcate
		double fa_bkg = bc_bkg*effval_bkg*effcate_bkg*kfac; // effcate*kfac  Remember to revert
		double fa_125 = bc_125*abs(effval)*effcate_sig; // effcate
		
		double a= (x*x-mean->getVal()*mean->getVal());
		double b = mean->getVal()*sigma->getVal();

		double cossig = a/TMath::Sqrt(a*a+b*b);
		double sinsig = b/TMath::Sqrt(a*a+b*b);
		double a125= (x*x-125.*125.);
		double b125 = 125*0.00407;

		double cossig125 = a125/TMath::Sqrt(a125*a125+b125*b125);
		double sinsig125 = b125/TMath::Sqrt(a125*a125+b125*b125);

		double maphase = x;
		if(x>1600 ){
			if(sample&&x>3000)
				maphase=3000;
			else if(!sample)
				maphase=1600.;
		}
		double cosfuncv=cosfunc->Eval(maphase);
		double sinfuncv=sinfunc->Eval(maphase);
		if(sample){
			cosfuncv = cosfuncv/1.76*2; 
			sinfuncv = sinfuncv/1.76*2; 
		}

		double sigbkgsqrt = TMath::Sqrt(fa_sig*fa_bkg); 
		double hbkgsqrt = TMath::Sqrt(fa_125*fa_bkg); 
		double sighsqrt = TMath::Sqrt(fa_sig*fa_125); 

		//Compute the interference components
		double inter_sig_bkgRe = 1.76*sigbkgsqrt*(cosfuncv*cossig);
		double inter_sig_bkgIm = 1.76*sigbkgsqrt*(sinfuncv*sinsig);
		double inter_125_bkgRe = 1.76*hbkgsqrt* (cosfuncv*cossig125);
		double inter_125_bkgIm = 1.76*hbkgsqrt* (sinfuncv*sinsig125); 
		double inter_sig_125 = 2*sighsqrt * (cossig125*cossig-sinsig125*sinsig); 
		
		
		int binN = xax->FindBin(x);

		double int_1=template_1->Integral(binN,binN);
		double int_2=template_2->Integral(binN,binN);
		double int_124=template_124->Integral(binN,binN);
		double int_124Im=template_124Im->Integral(binN,binN);

		for(int j = 0;j<template_1->GetNbinsY();j++){
			double cont1, cont2, cont124, cont124Im;
			cont1 = template_1->GetBinContent(binN,j+1);
			cont2 = template_2->GetBinContent(binN,j+1);
			cont124 = template_124->GetBinContent(binN,j+1);
			cont124Im = template_124Im->GetBinContent(binN,j+1);


			template_1r->SetBinContent(i+1,j+1,cont1*fa_sig);
			template_2r->SetBinContent(i+1,j+1,cont2*fa_bkg+cont1*fa_125+cont124*inter_125_bkgRe+cont124Im*inter_125_bkgIm);

			if(width_d>0.5)	
				template_124r->SetBinContent(i+1,j+1,cont124*inter_sig_bkgRe+cont124Im*inter_sig_bkgIm+cont1*inter_sig_125);
			else
				template_124r->SetBinContent(i+1,j+1,0);  
		}
	}

	for(int m =0;m< nbins; m++){
	        double genval = low +bwid*m;
		mzz->setVal(genval);

		int low_bound = genval + mean_p0_2nd->getVal() - sigma_p0_2nd->getVal()*30 ; 
		int high_bound = genval + mean_p0_2nd->getVal() + sigma_p0_2nd->getVal()*30 ; 
       		
		if(low_bound<low_reco)
			low_bound=low_reco;
		if(high_bound>high_reco)
			high_bound=high_reco;
		for(int k = low_bound;k<high_bound;k++){
			double recoval = k; 
			mreco->setVal(recoval);
			double reso = dcrReso_piece.getVal(*mreco); 
			if(reso<1.E-5)
				continue;

			double reso_up = dcrReso_piece_up.getVal(*mreco); 
			double reso_dn = dcrReso_piece_dn.getVal(*mreco); 

			for(int j =0;j< conv_template_1->GetNbinsY(); j++){
				double dbkg_val = conv_template_1->GetYaxis()->GetBinCenter(j+1);
        
				conv_template_1->Fill(recoval, dbkg_val,template_1r->GetBinContent(m+1,j+1)*reso);
				conv_template_2->Fill(recoval, dbkg_val,template_2r->GetBinContent(m+1,j+1)*reso);
				conv_template_124->Fill(recoval, dbkg_val,template_124r->GetBinContent(m+1,j+1)*reso);

				conv_template_1_up->Fill(recoval, dbkg_val,template_1r->GetBinContent(m+1,j+1)*reso_up);
				conv_template_2_up->Fill(recoval, dbkg_val,template_2r->GetBinContent(m+1,j+1)*reso_up);
				conv_template_124_up->Fill(recoval, dbkg_val,template_124r->GetBinContent(m+1,j+1)*reso_up);

				conv_template_1_dn->Fill(recoval, dbkg_val,template_1r->GetBinContent(m+1,j+1)*reso_dn);
				conv_template_2_dn->Fill(recoval, dbkg_val,template_2r->GetBinContent(m+1,j+1)*reso_dn);
				conv_template_124_dn->Fill(recoval, dbkg_val,template_124r->GetBinContent(m+1,j+1)*reso_dn);
			}
		}
	}
	
	//Template distribution projection on X axis for the 1D analysis
	TH1F *conv_template_1_proj = (TH1F*)conv_template_1->ProjectionX();
	TH1F *conv_template_2_proj = (TH1F*)conv_template_2->ProjectionX();
	TH1F *conv_template_124_proj= (TH1F*)conv_template_124->ProjectionX();

	TH1F *conv_template_1_proj_up = (TH1F*)conv_template_1_up->ProjectionX();
	TH1F *conv_template_2_proj_up = (TH1F*)conv_template_2_up->ProjectionX();
	TH1F *conv_template_124_proj_up= (TH1F*)conv_template_124_up->ProjectionX();

	TH1F *conv_template_1_proj_dn = (TH1F*)conv_template_1_dn->ProjectionX();
	TH1F *conv_template_2_proj_dn = (TH1F*)conv_template_2_dn->ProjectionX();
	TH1F *conv_template_124_proj_dn= (TH1F*)conv_template_124_dn->ProjectionX();
	
	//Create the histo and pdf for signal, bkg and interference
	//Using 2D templates
	if(is2D){
	        //Signal
		RooDataHist *pdfsig_hist_hist= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_1);
		RooHistFunc *pdfsig_hist_func= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*pdfsig_hist_hist);
		//Bkg
		RooDataHist* hgenm= new RooDataHist(Form("hgenm_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_2);
		RooHistFunc* hgenm_func= new RooHistFunc(Form("hgenm_func_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*hgenm);
		//Interference
		RooDataHist *inter_hist= new RooDataHist(Form("inter_hist_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_124);
		RooHistFunc *inter_func= new RooHistFunc(Form("inter_func_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*inter_hist);
		//Combination
		HZZ4L_RooHighmass *bsi_hist=new HZZ4L_RooHighmass("bsi_hist","bsi_hist",*mreco,*dbkg,*signorm,RooArgList(*pdfsig_hist_func,*hgenm_func,*inter_func)); 
		bsi_hist->SetNameTitle(dataName[sample],dataName[sample]);
	       
		RooDataHist *pdfsig_hist_hist_up= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_1_up);
		RooHistFunc *pdfsig_hist_func_up= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*pdfsig_hist_hist_up);

		RooDataHist* hgenm_up= new RooDataHist(Form("hgenm_%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_2_up);
		RooHistFunc* hgenm_func_up= new RooHistFunc(Form("hgenm_func_%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*hgenm_up);

		RooDataHist *inter_hist_up= new RooDataHist(Form("inter_hist_%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_124_up);
		RooHistFunc *inter_func_up= new RooHistFunc(Form("inter_func_%d_%s_%s_Resup",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*inter_hist_up);

		HZZ4L_RooHighmass *bsi_hist_up=new HZZ4L_RooHighmass("bsi_hist_Resup","bsi_hist_Resup",*mreco,*dbkg,*signorm,RooArgList(*pdfsig_hist_func_up,*hgenm_func_up,*inter_func_up)); 
		bsi_hist_up->SetNameTitle(dataName[sample]+"_Res"+chan+"Up",dataName[sample]+"Res"+chan+"Up");

		RooDataHist *pdfsig_hist_hist_dn= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_1_dn);
		RooHistFunc *pdfsig_hist_func_dn= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*pdfsig_hist_hist_dn);

		RooDataHist* hgenm_dn= new RooDataHist(Form("hgenm_%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_2_dn);
		RooHistFunc* hgenm_func_dn= new RooHistFunc(Form("hgenm_func_%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*hgenm_dn);

		RooDataHist *inter_hist_dn= new RooDataHist(Form("inter_hist_%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),conv_template_124_dn);
		RooHistFunc *inter_func_dn= new RooHistFunc(Form("inter_func_%d_%s_%s_Resdn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco,*dbkg),*inter_hist_dn);

		HZZ4L_RooHighmass *bsi_hist_dn=new HZZ4L_RooHighmass("bsi_hist_Resdn","bsi_hist_Resdn",*mreco,*dbkg,*signorm,RooArgList(*pdfsig_hist_func_dn,*hgenm_func_dn,*inter_func_dn)); 
		bsi_hist_dn->SetNameTitle(dataName[sample]+"_Res"+chan+"Down",dataName[sample]+"Res"+chan+"Down");

		w.import(*bsi_hist,RecycleConflictNodes());
		w.import(*bsi_hist_dn,RecycleConflictNodes());
		w.import(*bsi_hist_up,RecycleConflictNodes());
		w.importClassCode("HZZ4L_RooHighmass");
	}
	//Using 1D projections
	else{
		RooDataHist *pdfsig_hist_hist= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_1_proj);
		RooHistFunc *pdfsig_hist_func= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*pdfsig_hist_hist);

		RooDataHist* hgenm= new RooDataHist(Form("hgenm_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_2_proj);
		RooHistFunc* hgenm_func= new RooHistFunc(Form("hgenm_func_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*hgenm);

		RooDataHist *inter_hist= new RooDataHist(Form("inter_hist_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_124_proj);
		RooHistFunc *inter_func= new RooHistFunc(Form("inter_func_%d_%s_%s",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*inter_hist);

		HZZ4L_RooHighmass_1D *bsi_hist=new HZZ4L_RooHighmass_1D("bsi_hist","bsi_hist",*mreco,*signorm,RooArgList(*pdfsig_hist_func,*hgenm_func,*inter_func)); 
		bsi_hist->SetNameTitle(dataName[sample],dataName[sample]);

		RooDataHist *pdfsig_hist_hist_up= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_1_proj_up);
		RooHistFunc *pdfsig_hist_func_up= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*pdfsig_hist_hist_up);

		RooDataHist* hgenm_up	= new RooDataHist(Form("hgenm_%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_2_proj_up);
		RooHistFunc* hgenm_func_up= new RooHistFunc(Form("hgenm_func_%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*hgenm_up);

		RooDataHist *inter_hist_up= new RooDataHist(Form("inter_hist_%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_124_proj_up);
		RooHistFunc *inter_func_up= new RooHistFunc(Form("inter_func_%d_%s_%s_up",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*inter_hist_up);

		HZZ4L_RooHighmass_1D *bsi_hist_up=new HZZ4L_RooHighmass_1D("bsi_hist_up","bsi_hist_up",*mreco,*signorm,RooArgList(*pdfsig_hist_func_up,*hgenm_func_up,*inter_func_up)); 
		bsi_hist_up->SetNameTitle(dataName[sample]+"_Res"+chan+"Up",dataName[sample]+"_Res"+chan+"Up");

		RooDataHist *pdfsig_hist_hist_dn= new RooDataHist(Form("pdfsig_hist_hist%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_1_proj_dn);
		RooHistFunc *pdfsig_hist_func_dn= new RooHistFunc(Form("pdfsig_hist_func%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*pdfsig_hist_hist_dn);

		RooDataHist* hgenm_dn	= new RooDataHist(Form("hgenm_%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_2_proj_dn);
		RooHistFunc* hgenm_func_dn= new RooHistFunc(Form("hgenm_func_%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*hgenm_dn);

		RooDataHist *inter_hist_dn= new RooDataHist(Form("inter_hist_%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),conv_template_124_proj_dn);
		RooHistFunc *inter_func_dn= new RooHistFunc(Form("inter_func_%d_%s_%s_dn",cate_vbf,chan.Data(),dataName[sample].Data()),"",RooArgSet(*mreco),*inter_hist_dn);

		HZZ4L_RooHighmass_1D *bsi_hist_dn=new HZZ4L_RooHighmass_1D("bsi_hist_dn","bsi_hist_dn",*mreco,*signorm,RooArgList(*pdfsig_hist_func_dn,*hgenm_func_dn,*inter_func_dn)); 
		bsi_hist_dn->SetNameTitle(dataName[sample]+"_Res"+chan+"Down",dataName[sample]+"_Res"+chan+"Down");

		w.import(*bsi_hist,RecycleConflictNodes());
		w.import(*bsi_hist_up,RecycleConflictNodes());
		w.import(*bsi_hist_dn,RecycleConflictNodes());
		w.importClassCode("HZZ4L_RooHighmass_1D");
	}
	
	//Normalization of the different contributions
	ProcessNormalization* int_sig;
	ProcessNormalization* int_bkg;
	ProcessNormalization* int_int;

	float int_sig_norm = conv_template_1->Integral();
	float int_bkg_norm = conv_template_2->Integral();
	float int_int_norm = conv_template_124->Integral();

	float int_sig_up = conv_template_1_up->Integral();
	float int_bkg_up = conv_template_2_up->Integral();
	float int_int_up = conv_template_124_up->Integral();

	float int_sig_dn = conv_template_1_dn->Integral();
	float int_bkg_dn = conv_template_2_dn->Integral();
	float int_int_dn = conv_template_124_dn->Integral();
	
	int_sig = new ProcessNormalization("int_sig"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),"int_sig"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),int_sig_norm);
	int_bkg = new ProcessNormalization("int_bkg"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),"int_bkg"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),int_bkg_norm); 
	int_int = new ProcessNormalization("int_int"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),"int_int"+chan+"_"+dataName[sample]+Form("%d",cate_vbf),int_int_norm); 

	RooRealVar *sysrr=new RooRealVar("Res"+chan,"Res"+chan,-7,7);
	RooRealVar *kfacrr=new RooRealVar("kfactor_ggZZ","kfactor_ggZZ",-7,7);

	if(int_sig_norm!=0)
		int_sig->addAsymmLogNormal(int_sig_dn/int_sig_norm, int_sig_up/int_sig_norm, *sysrr);
	
       	if(int_bkg_norm!=0){
		int_bkg->addAsymmLogNormal(int_bkg_dn/int_bkg_norm, int_bkg_up/int_bkg_norm, *sysrr);
		if(sample==0)
		int_bkg->addAsymmLogNormal(0.9, 1.1, *kfacrr);
	}

	if(int_int_norm!=0){
		int_int->addAsymmLogNormal(int_int_dn/int_int_norm, int_int_up/int_int_norm, *sysrr);
		if(sample==0)
		int_int->addAsymmLogNormal(0.95, 1.05, *kfacrr);
	}

	RooFormulaVar *ggH_norm=new RooFormulaVar(dataName[sample]+"_norm",dataName[sample]+"_norm","@0*@3+@1+@2*sqrt(@3)",RooArgList(*int_sig,*int_bkg,*int_int,*signorm));
	w.import(*ggH_norm,RecycleConflictNodes());
	
	//Save the workspace in a .root file
	TFile *fwork ;

	if(width_d<0.1){
	  fwork= new TFile(Form("/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/workspaces/hzz4l_%s_%d_%dS_13TeV.input_func_%2.0f_%2.2f.root",chan.Data(),sample,cate_vbf,mass_d,width_d),"recreate");
	}
	else{
	  fwork= new TFile(Form("/eos/user/a/axbuchot/SWAN_projects/HighMass/ZZ4lNutuples/All/workspaces/hzz4l_%s_%d_%dS_13TeV.input_func_%2.0f_%2.1f.root",chan.Data(),sample,cate_vbf,mass_d,width_d),"recreate");
	}
	fwork->cd();
	w.Write();
	fwork->Close();
}

//Create the signal workspaces for the three decay channels with an inclusive category
//It takes as input the mass and width of the resonance, the production mode, and the number of template dimensions (1 or 2D)
//It could produce workspaces for many mass points,"loo" is  the number of mass points and "interval" is the mass difference between to points

void SignalWorkspaces_4l_HighMass(double m=500,double w=10,int sample =1,int is2D=1,double inteval=100,int loo=1){
  gStyle->SetOptStat(0);
  for(int i=0;i<loo;i++){
        workspaceProducer("2e2mu",m,w,sample,0,is2D);
	workspaceProducer("4e",m,w,sample,0,is2D);
	workspaceProducer("4mu",m,w,sample,0,is2D);

	m +=inteval;
  }
}
